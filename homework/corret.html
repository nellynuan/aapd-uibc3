<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>作業批改回饋區</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"
    />
    <style>
      body {
        background-color: #f7f6f5;
        height: 100vh;
        overflow: hidden;
      }

      tr {
        cursor: pointer;
      }

      .container {
        max-width: 1320px;
        padding: 48px 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        margin: 0 auto;
      }

      .text-box {
        padding: 16px 20px 12px 12px;
        border: 2px solid #dbdbdb;
        border-radius: 10px;
        background-color: #f8f8f7;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }

      .btn-copy {
        color: #6e7781;
      }
      .btn-clear {
        color: #df6b42;
      }

      .auto-resize-textarea {
        width: 100%;
        overflow: hidden;
        resize: none;
        background-color: transparent;
        border: none;
        outline: none;
      }

      .section-title {
        color: #6e7781;
        font-size: 24px;
        font-weight: 500;
      }

      .section-text {
        color: #32302C;
      }

      .section-text a {
        color: #32302C;
        text-decoration: underline;
      }

      .section-text a:hover {
        color: #1a1816;
      }

      .table-box {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        height: 100%;
        overflow-y: auto;
        box-shadow: 0px 4px 32px 0px rgba(0, 0, 0, 0.05);
        padding-top: 20px;
        padding-bottom: 20px;
      }

      .table-box::-webkit-scrollbar {
        width: 6px;
      }

      .table-box::-webkit-scrollbar-track {
        background: transparent;
      }

      .table-box::-webkit-scrollbar-thumb {
        background: #D1D5DB;
        border-radius: 3px;
      }

      .title {
        padding: 0 0 8px;
      }

      .title-success {
        color: #57ad57;
        border: 0 solid #57ad57;
        border-bottom-width: 1px;
      }
      .title-danger {
        color: #da0000;
        border: 0 solid #da0000;
        border-bottom-width: 1px;
      }

      .title-warning {
        color: #f89100;
        border: 0 solid #f89100;
        border-bottom-width: 1px;
      }

      .table-box h2 {
        font-size: 20px;
        font-weight: 500;
        display: flex;
        align-items: center;
      }

      .table-box h2 i {
        font-size: 20px;
        margin-right: 8px;
      }

      .table-box h2 small {
        font-size: 16px;
        font-weight: 400;
      }

      th {
        color: #a9b2ba !important;
        font-size: 14px;
      }

      td i {
        font-size: 24px;
      }

      .content-box {
        margin-bottom: 24px;
      }

      .content {
        background-color: white;
        padding: 20px 24px;
        border-radius: 16px 16px 0 16px;
      }

      .content-box small {
        color: #a9b2ba;
        font-size: 14px;
        padding: 8px;
      }

      h3 {
        font-size: 16px;
      }

      .top-section {
        flex-shrink: 0;
        margin-bottom: 24px;
      }

      .bottom-section {
        flex: 1;
        min-height: 0;
      }

      .top-left {
        flex: 1;
      }

      .top-right {
        width: 600px;
      }

      .bottom-left {
        width: 664px;
      }

      .bottom-right {
        flex: 1;
      }

      .left-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .feedback-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 8px;
        margin-bottom: 60px;
        min-height: 0;
      }

      .feedback-buttons {
        position: absolute;
        bottom: 12px;
        right: 20px;
        flex-shrink: 0;
      }

      .condition-group {
        padding-top: 8px;
      }

      .condition-item {
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: background-color 0.2s;
      }

      .condition-buttons {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .condition-btn {
        width: 32px;
        height: 32px;
        border: 1px solid #D0D7DE;
        border-radius: 4px;
        background: #FFFFFF;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .condition-btn i {
        font-size: 20px;
      }

      .condition-btn.correct-btn i {
        color: #57AD57;
      }

      .condition-btn.correct-btn:hover {
        border-color: #BADEBA;
        background-color: #EEF7EE;
      }

      .condition-btn.correct-btn:hover i {
        color: #57AD57;
      }

      .condition-btn.correct-btn.active-correct {
        border-color: #BADEBA;
        background-color: #57AD57;
      }

      .condition-btn.correct-btn.active-correct i {
        color: #FFFFFF;
      }

      .condition-btn.incorrect-btn i {
        color: #DF6B42;
      }

      .condition-btn.incorrect-btn:hover {
        border-color: #F0BBA8;
        background-color: #FBEEE9;
      }

      .condition-btn.incorrect-btn:hover i {
        color: #DF6B42;
      }

      .condition-btn.incorrect-btn.active-incorrect {
        border-color: #F0BBA8;
        background-color: #DF6B42;
      }

      .condition-btn.incorrect-btn.active-incorrect i {
        color: #FFFFFF;
      }

      .condition-text {
        flex: 1;
        font-size: 16px;
        color: #374151;
        padding: 8px 0;
        line-height: 1.5;
        min-height: 24px;
        display: flex;
        align-items: center;
      }

      .category-row {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        font-size: 16px;
        color: #AFB8C1;
      }

      .info-button {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #AFB8C1;
        cursor: pointer;
        border-radius: 4px;
        margin-left: 4px;
      }

      .info-button:hover {
        background-color: transparent;
      }

      .info-button i {
        font-size: 20px;
        transition: all 0.2s;
      }

      .category-items .condition-item {
        display: flex;
        align-items: center;
        padding: 4px 0;
        margin-bottom: 4px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .category-items .condition-item:hover {
        background-color: #F7F6F5;
      }

      .category-items .condition-item i {
        color: #6E7781;
        font-size: 24px;
        margin-right: 8px;
      }

      #previewArea h3 {
        font-size: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="top-section">
        <div class="d-flex gap-3">
          <div class="top-left">
            <div class="p-3">
              <h1 class="section-title">
                助教 <span id="ta_text"></span> 的
                <span id="work_text"></span> 作業批改區
              </h1>
              <ol class="section-text mt-3">
                <li>記得檢查是否有更新作業小卡上「繳交狀態」、「批改狀態」、「批改班長」的欄位</li>
                <li>批改完成後，記得將右側的「作業表現」結果更新至「<a href="https://www.notion.so/simonlin7972/UIBC-3-1f895b29efc980bc9a2ef5a24eba8e60?source=copy_link#1f895b29efc980b684f8f67bc8b00721" target="_blank">班長作業＆專案批改區</a>」</li>
              </ol>
            </div>
          </div>
          <div class="top-right">
            <div class="d-flex gap-3 h-100 align-items-end">
              <div class="content-box w-100">
                <div class="content">
                  這份作業在「基礎錯誤」項目有被扣分，因此作業評級為「有待加強」
                </div>
                <small>批改結果僅作為參考，助教仍可斟酌調整評級</small>
              </div>
              <div class="d-flex align-items-end">
                <img
                  src="https://i.ibb.co/qFYQP9Wg/Student-Avatar.png"
                  style="width: 60px; height: 60px;"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bottom-section">
        <div class="d-flex gap-2 h-100">
          <div class="bottom-left">
            <div class="text-box">
              <div class="d-flex gap-2 h-100" style="align-items: flex-start;">
                <div class="edit-icon" style="flex-shrink: 0;">
                  <img
                    src="https://www.notion.so/icons/drafts_gray.svg?mode=light"
                    style="width: 24px"
                  />
                </div>
                <div class="feedback-content">
                  <div id="previewArea"></div>
                </div>
              </div>

              <div class="feedback-buttons d-flex justify-content-end">
                <button class="btn btn-copy" onclick="copyFeedback()">
                  <i class="ph ph-copy me-1"></i>複製
                </button>
                <button class="btn btn-clear" onclick="clearFeedback()">
                  <i class="ph ph-broom me-1"></i>清除
                </button>
              </div>
            </div>
          </div>

          <div class="bottom-right">
            <div class="table-box">
              <div>
                <h2
                  class="d-flex justify-content-between align-items-end title title-success"
                >
                  <span><i class="ph-fill ph-triangle"></i>基礎條件</span>
                </h2>

                <div class="condition-group" id="condition-group-1">
                  <!-- 基礎條件項目會動態生成在這裡 -->
                </div>
              </div>
              <div class="pt-4">
                <h2
                  class="d-flex justify-content-between align-items-end title title-warning"
                >
                  <span><i class="ph-fill ph-shapes"></i>進階條件</span>
                </h2>

                <div id="advanced-conditions"></div>
              </div>
              <div class="pt-4">
                <h2
                  class="d-flex justify-content-between align-items-end title title-danger"
                >
                  <span><i class="ph ph-shapes"></i>挑戰條件</span>
                </h2>

                <div id="challenge-conditions"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let totalScore = 0;
      let openingText = "";
      let closingText = "";
      let md = "";
      let feedbackList = [];
      let originalOrder = [];
      let originalOrderAdvanced = {};
      let originalOrderChallenge = {};

      const api = {
        Week1:
          "https://script.google.com/macros/s/AKfycbyxa9E3B32vr1aYXVGWttrUdPtS7huVZOU30r_surMb-R500rRD0DbZzofVWfXogPpt/exec",
        Week2:
          "https://script.google.com/macros/s/AKfycbxBsdr6vJEia049Y-yymZdJZRqJr9F7a80i6PQTya-GkQITqIlxHhF_l5paa8IlvxI/exec",
        Week3:
          "https://script.google.com/macros/s/AKfycbxC-CfDsxOeWGmbiEIFoN248cZKVtCHBXb9fMKkOlF7VhDHgXFsTf0iyaJ2vZqt6d7WbQ/exec",
      };

      const params = new URLSearchParams(window.location.search);
      const work = params.get("work");
      const ta = params.get("ta");
      document.getElementById("ta_text").innerText = ta;
      document.getElementById("work_text").innerText = work;

      Swal.fire({
        title: "改完作業要記得休息喔！",
        text: "資料比較多，給它一點時間...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      fetch(api[work] + "?ta=" + ta)
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          openingText = data.opening;
          closingText = data.closing;
          createButtons(data.praiseData, "tbody-1", "praise");
          createButtons(data.baseDeductData, "tbody-2", "base");
          createButtons(data.advDeductData, "tbody-3", "adv");
          updateFeedbackArea();
          Swal.close();
        })
        .catch((error) => {
          alert("發生錯誤 " + error);
        });

      function createButtons(items, containerId, type) {
        console.log(items);
        
        if (type === "praise") {
          const container = document.getElementById("condition-group-1");
          
          const groupedItems = {};
          const itemOrder = [];
          
          items.forEach(([title, description, content, result]) => {
            if (!groupedItems[title]) {
              groupedItems[title] = { description: description };
              itemOrder.push(title);
            }
            groupedItems[title][result] = content;
          });
          
          originalOrder = itemOrder;
          
          itemOrder.forEach(title => {
            const div = document.createElement("div");
            div.className = "condition-item";
            div.dataset.title = title;
            
            div.innerHTML = `
              <div class="condition-buttons">
                <button class="condition-btn correct-btn" data-type="O">
                  <i class="ph ph-circle"></i>
                </button>
                <button class="condition-btn incorrect-btn" data-type="X">
                  <i class="ph ph-x"></i>
                </button>
              </div>
              <div class="condition-text">${title}</div>
              <button class="info-button" title="${groupedItems[title].description}" onmouseenter="this.querySelector('i').className='ph-fill ph-info'" onmouseleave="this.querySelector('i').className='ph ph-info'">
                <i class="ph ph-info"></i>
              </button>
            `;
            
            const correctBtn = div.querySelector('.correct-btn');
            const incorrectBtn = div.querySelector('.incorrect-btn');
            
            correctBtn.onclick = (e) => {
              e.stopPropagation();
              handleConditionClick(title, 'O', groupedItems[title]['O'], correctBtn, incorrectBtn, type);
            };
            
            incorrectBtn.onclick = (e) => {
              e.stopPropagation();
              handleConditionClick(title, 'X', groupedItems[title]['X'], incorrectBtn, correctBtn, type);
            };
            
            container.appendChild(div);
          });
          
        } else if (type === "base" || type === "adv") {
          const targetDiv = type === "base" ? "advanced-conditions" : "challenge-conditions";
          
          const categorizedItems = {};
          const categoryOrder = {};
          
          items.forEach(([category, categoryDesc, item, content, score]) => {
            if (!categorizedItems[category]) {
              categorizedItems[category] = {
                description: categoryDesc,
                items: []
              };
              categoryOrder[category] = [];
            }
            categorizedItems[category].items.push([item, content, score]);
            categoryOrder[category].push(item);
          });
          
          if (type === "base") {
            originalOrderAdvanced = categoryOrder;
          } else {
            originalOrderChallenge = categoryOrder;
          }
          
          Object.keys(categorizedItems).forEach(category => {
            const categoryData = categorizedItems[category];
            
            const categoryDiv = document.createElement("div");
            categoryDiv.className = "category-section";
            categoryDiv.innerHTML = `
              <div class="category-row" style="margin-top: 12px;">
                <span>${category}</span>
                <button class="info-button" title="${categoryData.description}" onmouseenter="this.querySelector('i').className='ph-fill ph-info'" onmouseleave="this.querySelector('i').className='ph ph-info'">
                  <i class="ph ph-info"></i>
                </button>
              </div>
              <div class="category-items" id="${targetDiv}-${category.replace(/\s+/g, '-')}"></div>
            `;
            
            const targetElement = document.querySelector(`#${targetDiv}`);
            if (targetElement) {
              targetElement.appendChild(categoryDiv);
            }
            
            const itemsContainer = categoryDiv.querySelector('.category-items');
            categoryData.items.forEach(([item, content, score]) => {
              const itemDiv = document.createElement("div");
              itemDiv.className = "condition-item";
              itemDiv.dataset.category = category;
              itemDiv.dataset.item = item;
              itemDiv.innerHTML = `
                <i class="ph ph-square" style="font-size: 24px; color: #6E7781; margin-right: 8px;"></i>
                <span style="margin-right: 8px;">${score > 0 ? '+' + score : score}</span>
                <span style="flex: 1;">${item}</span>
              `;
              
              itemDiv.onclick = () => {
                handleCategoryItemClick(category, item, content, score, type, itemDiv);
              };
              
              itemsContainer.appendChild(itemDiv);
            });
          });
        }
      }
      
      function handleCategoryItemClick(category, item, content, score, type, clickedDiv) {
        const icon = clickedDiv.querySelector("i");
        const isSelected = icon.classList.contains("ph-check-square");
        
        if (isSelected) {
          icon.classList.remove("ph-fill", "ph-check-square");
          icon.classList.add("ph", "ph-square");
          deleteItem(item, content, score, type);
        } else {
          const categoryItems = document.querySelectorAll(`[data-category="${category}"]`);
          categoryItems.forEach(div => {
            const otherIcon = div.querySelector("i");
            if (otherIcon.classList.contains("ph-check-square")) {
              otherIcon.classList.remove("ph-fill", "ph-check-square");
              otherIcon.classList.add("ph", "ph-square");
              const otherItem = div.dataset.item;
              feedbackList = feedbackList.filter(f => !(f.type === type && f.title === otherItem));
            }
          });
          
          icon.classList.remove("ph", "ph-square");
          icon.classList.add("ph-fill", "ph-check-square");
          addItem(item, content, score, type);
        }
        
        updateFeedbackArea();
      }
      
      function handleConditionClick(title, result, content, activeBtn, otherBtn, type) {
        otherBtn.classList.remove('active-correct', 'active-incorrect');
        
        const isCurrentlyActive = activeBtn.classList.contains('active-correct') || 
                                 activeBtn.classList.contains('active-incorrect');
        
        if (isCurrentlyActive) {
          activeBtn.classList.remove('active-correct', 'active-incorrect');
          deleteItem(title, content, 0, type);
        } else {
          if (result === 'O') {
            activeBtn.classList.add('active-correct');
          } else {
            activeBtn.classList.add('active-incorrect');
          }
          
          feedbackList = feedbackList.filter(item => item.title !== title);
          addItem(title, content, 0, type);
        }
      }

      function addItem(title, content, score, type) {
        const item = {
          content: `- ${content}`,
          title,
          score: parseInt(score),
          type,
        };
        feedbackList.push(item);
        updateFeedbackArea();
      }

      function deleteItem(title, content, score, type) {
        feedbackList = feedbackList.filter(
          (i) => !(i.title === title && i.type === type)
        );
        updateFeedbackArea();
      }

      function updateFeedbackArea() {
        console.log(feedbackList);
        
        const orderedBasicConditions = [];
        if (originalOrder.length > 0) {
          originalOrder.forEach(title => {
            const item = feedbackList.find(f => f.type === "praise" && f.title === title);
            if (item) {
              orderedBasicConditions.push(item.content);
            }
          });
        }
        
        const orderedAdvancedConditions = [];
        Object.keys(originalOrderAdvanced).forEach(category => {
          originalOrderAdvanced[category].forEach(itemTitle => {
            const item = feedbackList.find(f => f.type === "base" && f.title === itemTitle);
            if (item) {
              orderedAdvancedConditions.push(item.content);
            }
          });
        });
        
        const orderedChallengeConditions = [];
        Object.keys(originalOrderChallenge).forEach(category => {
          originalOrderChallenge[category].forEach(itemTitle => {
            const item = feedbackList.find(f => f.type === "adv" && f.title === itemTitle);
            if (item) {
              orderedChallengeConditions.push(item.content);
            }
          });
        });
        
        const basic = orderedBasicConditions.length > 0 ? orderedBasicConditions.join("\n\n") : "- ";
        const advanced = orderedAdvancedConditions.length > 0 ? orderedAdvancedConditions.join("\n\n") : "";
        const challenge = orderedChallengeConditions.length > 0 ? orderedChallengeConditions.join("\n\n") : "";
        
        let feedbackContent = `${openingText}\n\n### 基礎條件\n${basic}`;
        
        if (advanced) {
          feedbackContent += `\n\n### 進階條件\n${advanced}`;
        }
        
        if (challenge) {
          feedbackContent += `\n\n### 挑戰條件\n${challenge}`;
        }
        
        feedbackContent += `\n\n${closingText}`;
        
        md = feedbackContent;
        document.getElementById("previewArea").innerHTML = marked.parse(md);
      }

      function copyFeedback() {
        navigator.clipboard
          .writeText(md)
          .then(() => {
            Swal.fire({
              icon: "success",
              title: "已複製",
              showConfirmButton: false,
              timer: 1500,
            });
          })
          .catch((err) => {
            Swal.fire({
              title: "複製失敗",
              showConfirmButton: false,
              timer: 1500,
            });
          });
      }

      function clearFeedback() {
        feedbackList = [];
        updateFeedbackArea();

        const icons = document.querySelectorAll("tr i");

        icons.forEach((icon) => {
          if (icon.classList.contains("ph-check-square")) {
            icon.classList.remove("ph-fill");
            icon.classList.remove("ph-check-square");
            icon.classList.add("ph");
            icon.classList.add("ph-square");
          }
        });
      }
    </script>
  </body>
</html>
