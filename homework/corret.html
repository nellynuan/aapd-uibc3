<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ä½œæ¥­æ‰¹æ”¹å›é¥‹å€</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"
    />
    <style>
      body {
        background-color: #f7f6f5;
        height: 100vh;
        overflow: hidden;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      /* é è¨­éš±è—æ‰€æœ‰è¨Šæ¯å’Œä¸»è¦å…§å®¹ */
      .mobile-message,
      .tablet-message,
      .main-content {
        display: none;
      }

      /* å°æ–¼ 420px */
      @media (max-width: 419px) {
        .mobile-message {
          display: flex;
          align-items: center;
          justify-content: center;
          height: 100vh;
          font-size: 18px;
          color: #6e7781;
          text-align: center;
          padding: 20px;
        }
      }

      /* 420px åˆ° 849px */
      @media (min-width: 420px) and (max-width: 849px) {
        .tablet-message {
          display: flex;
          align-items: center;
          justify-content: center;
          height: 100vh;
          font-size: 18px;
          color: #6e7781;
          text-align: center;
          padding: 20px;
        }
      }

      /* 850px ä»¥ä¸Šæ‰é¡¯ç¤ºä¸»è¦å…§å®¹ */
      @media (min-width: 850px) {
        .main-content {
          display: flex;
        }
      }

      /* lg: 850px+ */
      @media (min-width: 850px) {
        .container {
          padding-left: 16px;
          padding-right: 16px;
        }
        
        .top-section .d-flex {
          gap: 8px !important;
        }
        
        .top-right .d-flex {
          gap: 8px !important;
        }
        
        .top-right {
          width: 400px !important;
        }
      }

      /* xl: 1200px+ */
      @media (min-width: 1200px) {
        .top-section .d-flex {
          gap: 16px !important;
        }
        
        .top-right {
          width: 580px !important;
        }
      }

      /* xxl: 1352px+ */
      @media (min-width: 1352px) {
        .top-right {
          width: 600px !important;
        }
        
        .top-section .d-flex {
          gap: 24px !important;
        }
      }

      tr {
        cursor: pointer;
      }

      .container {
        max-width: 1320px;
        padding: 48px 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        margin: 0 auto;
      }

      .text-box {
        padding: 16px 20px 12px 12px;
        border: 2px solid #dbdbdb;
        border-radius: 10px;
        background-color: #f8f8f7;
        height: 100%;
        display: flex;
        flex-direction: column;
        /* ğŸ¯ ä¿æŒ overflow: hidden é¿å…æº¢å‡º */
        overflow: hidden;
        position: relative;
      }

      .btn-copy {
        color: #6e7781;
      }
      .btn-clear {
        color: #df6b42;
      }

      .auto-resize-textarea {
        width: 100%;
        overflow: hidden;
        resize: none;
        background-color: transparent;
        border: none;
        outline: none;
      }

      .section-title {
        color: #6e7781;
        font-size: 24px;
        font-weight: 500;
      }

      .section-text {
        color: #32302C;
      }

      .section-text a {
        color: #32302C;
        text-decoration: underline;
      }

      .section-text a:hover {
        color: #1a1816;
      }

      .table-box {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        height: 100%;
        overflow-y: auto;
        box-shadow: 0px 4px 32px 0px rgba(0, 0, 0, 0.05);
        padding-top: 20px;
        padding-bottom: 20px;
      }

      /* Bootstrap tooltip è‡ªè¨‚æ¨£å¼ */
      .tooltip-inner {
        max-width: 300px !important;
        width: max-content;
      }

      /* Modal è‡ªè¨‚æ¨£å¼ */
      #incompleteModal .modal-content {
        padding: 24px;
      }

      #incompleteModal .modal-header {
        display: none;
      }

      #incompleteModal .modal-body {
        text-align: center;
        padding: 0;
      }

      #incompleteModal .modal-body img {
        margin-top: 24px;
        width: 200px;
        border-radius: 8px;
      }

      #incompleteModal .modal-footer {
        border-top: none;
        justify-content: center;
        padding: 0;
        margin-top: 24px;
      }

      #incompleteModal .btn-primary {
        background-color: #0C4285;
        border-color: #0C4285;
      }

      #incompleteModal .btn-primary:hover {
        background-color: #0a3a75;
        border-color: #0a3a75;
      }

      #incompleteModal .btn-close {
        position: absolute;
        top: 12px;
        right: 12px;
        background: none;
        border: none;
        font-size: 24px;
        opacity: 0.5;
        z-index: 1050;
        color: #000;
        width: auto;
        height: auto;
        padding: 0;
      }

      #incompleteModal .btn-close:hover {
        opacity: 1;
      }

      #incompleteModal .btn-close:focus {
        outline: none !important;
        box-shadow: none !important;
      }

      .btn-copy {
        position: relative;
      }

      .btn-copy:focus,
      .btn-clear:focus {
        outline: none;
        box-shadow: none;
      }

      .table-box::-webkit-scrollbar {
        width: 6px;
      }

      .table-box::-webkit-scrollbar-track {
        background: transparent;
      }

      .table-box::-webkit-scrollbar-thumb {
        background: #D1D5DB;
        border-radius: 3px;
      }

      .title {
        padding: 0 0 8px;
      }

      .title-success {
        color: #57ad57;
        border: 0 solid #57ad57;
        border-bottom-width: 1px;
      }
      .title-danger {
        color: #da0000;
        border: 0 solid #da0000;
        border-bottom-width: 1px;
      }

      .title-warning {
        color: #f89100;
        border: 0 solid #f89100;
        border-bottom-width: 1px;
      }

      .table-box h2 {
        font-size: 20px;
        font-weight: 500;
        display: flex;
        align-items: center;
      }

      .table-box h2 i {
        font-size: 20px;
        margin-right: 8px;
      }

      .table-box h2 small {
        font-size: 16px;
        font-weight: 400;
      }

      th {
        color: #a9b2ba !important;
        font-size: 14px;
      }

      td i {
        font-size: 24px;
      }

      .content-box {
        margin-bottom: 24px;
      }

      .content {
        background-color: white;
        padding: 20px 24px;
        border-radius: 16px 16px 0 16px;
      }

      .content-box small {
        color: #a9b2ba;
        font-size: 14px;
        padding: 8px;
      }

      h3 {
        font-size: 16px;
      }

      .top-section {
        flex-shrink: 0;
        margin-bottom: 24px;
      }

      .bottom-section {
        flex: 1;
        min-height: 0;
      }

      .feedback-content p {
        margin-bottom: 4px;
      }

      .top-left {
        flex: 1;
      }

      .top-right {
        width: 600px;
      }

      .bottom-left {
        width: 664px;
        margin-right: 16px;
      }

      .bottom-right {
        flex: 1;
      }

      .left-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      /* ğŸ¯ æ–°å¢ï¼šå…§å®¹åŒ…è£å±¤ï¼Œé—œéµæ˜¯é€™å€‹ï¼ */
      .feedback-wrapper {
        flex: 1;
        min-height: 0;
        display: flex;
        gap: 8px;
        align-items: flex-start;
      }

      /* ğŸ¯ ä¿®å¾©æ»¾å‹•å€åŸŸ */
      .feedback-content {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        padding-right: 8px;
        /* ğŸ”§ èª¿æ•´ padding-bottomï¼Œç‚ºæŒ‰éˆ•ç•™å‡ºç©ºé–“ */
        padding-bottom: 70px;
      }

      /* ğŸ¯ è®“ previewArea å…§å®¹è‡ªç„¶å±•é–‹ */
      #previewArea {
        padding-right: 8px;
      }

      /* ğŸ¯ ç¾åŒ–æ»¾å‹•æ¢ */
      .feedback-content::-webkit-scrollbar {
        width: 6px;
      }

      .feedback-content::-webkit-scrollbar-track {
        background: transparent;
      }

      .feedback-content::-webkit-scrollbar-thumb {
        background: #D1D5DB;
        border-radius: 3px;
      }

      .feedback-buttons {
        position: absolute;
        bottom: 12px;
        right: 20px;
        flex-shrink: 0;
        background: rgba(248, 248, 247, 0.95);
        padding: 8px;
        border-radius: 8px;
        backdrop-filter: blur(10px);
        /* ğŸ¯ ç¢ºä¿æŒ‰éˆ•åœ¨æœ€ä¸Šå±¤ */
        z-index: 10;
      }

      .condition-group {
        padding-top: 8px;
      }

      .condition-item {
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s;
      }

      .condition-buttons {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .condition-btn {
        width: 32px;
        height: 32px;
        border: 1px solid #D0D7DE;
        border-radius: 4px;
        background: #FFFFFF;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .condition-btn i {
        font-size: 20px;
      }

      .condition-btn.correct-btn i {
        color: #57AD57;
      }

      .condition-btn.correct-btn:hover {
        border-color: #BADEBA;
        background-color: #EEF7EE;
      }

      .condition-btn.correct-btn:hover i {
        color: #57AD57;
      }

      .condition-btn.correct-btn.active-correct {
        border-color: #BADEBA;
        background-color: #57AD57;
      }

      .condition-btn.correct-btn.active-correct i {
        color: #FFFFFF;
      }

      .condition-btn.incorrect-btn i {
        color: #DF6B42;
      }

      .condition-btn.incorrect-btn:hover {
        border-color: #F0BBA8;
        background-color: #FBEEE9;
      }

      .condition-btn.incorrect-btn:hover i {
        color: #DF6B42;
      }

      .condition-btn.incorrect-btn.active-incorrect {
        border-color: #F0BBA8;
        background-color: #DF6B42;
      }

      .condition-btn.incorrect-btn.active-incorrect i {
        color: #FFFFFF;
      }

      .condition-text {
        flex: 1;
        font-size: 16px;
        color: #374151;
        padding: 8px 0;
        line-height: 1.5;
        min-height: 24px;
        display: flex;
        align-items: center;
      }

      .category-row {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        font-size: 16px;
        color: #AFB8C1;
      }

      .info-button {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #AFB8C1;
        cursor: pointer;
        border-radius: 4px;
        position: relative;
      }

      .info-button:hover {
        background-color: transparent;
      }

      .info-button i {
        font-size: 20px;
        transition: all 0.2s;
      }

      .category-items .condition-item {
        display: flex;
        align-items: center;
        padding: 4px;
        margin-bottom: 4px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .category-items .condition-item:hover {
        background-color: #F7F6F5;
      }

      .category-items .condition-item i {
        color: #6E7781;
        font-size: 24px;
        margin-right: 8px;
      }

      #previewArea h3 {
        font-size: 20px;
        margin-top: 16px;
      }

      .copy-toast {
        position: absolute;
        top: -50px;
        right: 0;
        background: #2A2A3A;
        color: white;
        padding: 12px 16px;
        border-radius: 4px;
        font-size: 16px;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
        pointer-events: none;
        white-space: nowrap;
        z-index: 1000;
      }

      .copy-toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      #incompleteModal .btn-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
      }

      .btn-copy:focus,
      .btn-clear:focus {
        outline: none;
        box-shadow: none;
      }
    </style>
  </head>
  <body>
    <!-- æ‰‹æ©Ÿç‰ˆè¨Šæ¯ -->
    <div class="mobile-message">
      ä¸å¯èƒ½é‚„æƒ³ç”¨æ‰‹æ©Ÿæ‰¹æ”¹æ¬¸ï¼è«‹å»èººå¹³ä¼‘æ¯è¬è¬
    </div>
    
    <!-- å¹³æ¿ç‰ˆè¨Šæ¯ -->
    <div class="tablet-message">
      é€™å€‹å¯¬åº¦ä¸é©åˆæ‰¹æ”¹å›‰ï¼å†å¹«æˆ‘æ‹‰å¤§ä¸€é»
    </div>
    
    <!-- ä¸»è¦å…§å®¹ -->
    <div class="main-content">
    <div class="container">
      <div class="top-section">
        <div class="d-flex gap-3">
          <div class="top-left">
            <div class="p-3">
              <h1 class="section-title">
                åŠ©æ•™ <span id="ta_text"></span> çš„
                <span id="work_text"></span> ä½œæ¥­æ‰¹æ”¹å€
              </h1>
              <ol class="section-text mt-3">
                <li>è¨˜å¾—æª¢æŸ¥æ˜¯å¦æœ‰æ›´æ–°ä½œæ¥­å°å¡ä¸Šã€Œç¹³äº¤ç‹€æ…‹ã€ã€ã€Œæ‰¹æ”¹ç‹€æ…‹ã€ã€ã€Œæ‰¹æ”¹ç­é•·ã€çš„æ¬„ä½</li>
                <li>æ‰¹æ”¹å®Œæˆå¾Œï¼Œè¨˜å¾—å°‡å³å´çš„ã€Œä½œæ¥­è¡¨ç¾ã€çµæœæ›´æ–°è‡³ã€Œ<a href="https://www.notion.so/simonlin7972/UIBC-3-1f895b29efc980bc9a2ef5a24eba8e60?source=copy_link#1f895b29efc980b684f8f67bc8b00721" target="_blank">ç­é•·ä½œæ¥­ï¼†å°ˆæ¡ˆæ‰¹æ”¹å€</a>ã€</li>
              </ol>
            </div>
          </div>
          <div class="top-right">
            <div class="d-flex gap-3 h-100 align-items-end">
              <div class="content-box w-100">
                <div class="content" id="grading-result" style="color: #6E7781;">
                  é€™ä»½ä½œæ¥­å°šæœªæ‰¹æ”¹å®Œæˆ
                </div>
                <small>æ‰¹æ”¹çµæœåƒ…ä½œç‚ºåƒè€ƒï¼ŒåŠ©æ•™ä»å¯æ–Ÿé…Œèª¿æ•´ä½œæ¥­è¡¨ç¾çµæœ</small>
              </div>
              <div class="d-flex align-items-end">
                <img
                  src="https://i.ibb.co/qFYQP9Wg/Student-Avatar.png"
                  style="width: 60px; height: 60px;"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bottom-section">
        <div class="d-flex gap-2 h-100">
          <div class="bottom-left">
            <div class="text-box">
              <!-- ğŸ¯ æ–°å¢åŒ…è£å±¤ä¾†æ­£ç¢ºè™•ç† flex é«˜åº¦ -->
              <div class="feedback-wrapper">
                <div class="edit-icon" style="flex-shrink: 0;">
                  <img
                    src="https://www.notion.so/icons/drafts_gray.svg?mode=light"
                    style="width: 24px"
                  />
                </div>
                <div class="feedback-content">
                  <div id="previewArea"></div>
                </div>
              </div>

              <div class="feedback-buttons d-flex justify-content-end">
                <button class="btn btn-copy" onclick="copyFeedback()">
                  <i class="ph ph-copy me-1"></i>è¤‡è£½
                </button>
                <button class="btn btn-clear" onclick="clearFeedback()">
                  <i class="ph ph-broom me-1"></i>æ¸…é™¤
                </button>
              </div>
            </div>
          </div>

          <div class="bottom-right">
            <div class="table-box">
              <div>
                <h2
                  class="d-flex justify-content-between align-items-end title title-success"
                >
                  <span><i class="ph-fill ph-triangle"></i>åŸºæœ¬æ¢ä»¶</span>
                </h2>

                <div class="condition-group" id="condition-group-1">
                  <!-- åŸºæœ¬æ¢ä»¶é …ç›®æœƒå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                </div>
              </div>
              <div class="pt-4">
                <h2
                  class="d-flex justify-content-between align-items-end title title-warning"
                >
                  <span><i class="ph-fill ph-shapes"></i>é€²éšæ¢ä»¶</span>
                </h2>

                <div id="advanced-conditions"></div>
              </div>
              <div class="pt-4">
                <h2
                  class="d-flex justify-content-between align-items-end title title-danger"
                >
                  <span><i class="ph ph-sketch-logo"></i>æŒ‘æˆ°æ¢ä»¶</span>
                </h2>

                <div id="challenge-conditions"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- Bootstrap Modal for incomplete conditions -->
    <div class="modal fade" id="incompleteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body">
            é‚„æœ‰ã€ŒåŸºæœ¬æ¢ä»¶ã€æ²’æœ‰æ‰¹æ”¹å®Œæˆï¼Œå†æª¢æŸ¥ä¸€ä¸‹å–”ï¼
            <img src="https://scontent.ftpe7-2.fna.fbcdn.net/v/t39.30808-6/471303619_10231175542870148_2440793267832562341_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=bd9a62&_nc_ohc=tKW0VMW_BU0Q7kNvwGKxRDP&_nc_oc=AdlS99lfZRhSSn0Wma8KTLHBg8kN0wwj6nT8tocSRZR_Tzdu569NiTsK5m_GNUzupR57k1-IcdXWUP3wy3bGgaOS&_nc_zt=23&_nc_ht=scontent.ftpe7-2.fna&_nc_gid=Klf05YcoIqCIIKbSWFZ5Cw&oh=00_AfP_RzgutrwUzPu6WAlldszGhM3yToDLa6nRurd6Gdjvow&oe=684AF1B1" alt="ä¿®ä½†å¹¾å‹’">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">å¥½çš„</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let totalScore = 0;
      let openingText = "";
      let closingText = "";
      let md = "";
      let feedbackList = [];
      let originalOrder = [];
      let originalOrderAdvanced = {};
      let originalOrderChallenge = {};
      // æ–°å¢ï¼šå­˜å„²æ¯å€‹é¡åˆ¥çš„ç¸½é …ç›®æ•¸
      let categoryItemCounts = {
        advanced: {},
        challenge: {}
      };

      const api = {
        Week1:
          "https://script.google.com/macros/s/AKfycbyxa9E3B32vr1aYXVGWttrUdPtS7huVZOU30r_surMb-R500rRD0DbZzofVWfXogPpt/exec",
        Week2:
          "https://script.google.com/macros/s/AKfycbxBsdr6vJEia049Y-yymZdJZRqJr9F7a80i6PQTya-GkQITqIlxHhF_l5paa8IlvxI/exec",
        Week3:
          "https://script.google.com/macros/s/AKfycbxC-CfDsxOeWGmbiEIFoN248cZKVtCHBXb9fMKkOlF7VhDHgXFsTf0iyaJ2vZqt6d7WbQ/exec",
      };

      const params = new URLSearchParams(window.location.search);
      const work = params.get("work");
      const ta = params.get("ta");
      document.getElementById("ta_text").innerText = ta;
      document.getElementById("work_text").innerText = work;

      Swal.fire({
        title: "æ”¹å®Œä½œæ¥­è¦è¨˜å¾—ä¼‘æ¯å–”ï¼",
        text: "è³‡æ–™æ¯”è¼ƒå¤šï¼Œçµ¦å®ƒä¸€é»æ™‚é–“...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      fetch(api[work] + "?ta=" + ta)
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          openingText = data.opening;
          closingText = data.closing;
          createButtons(data.praiseData, "tbody-1", "praise");
          createButtons(data.baseDeductData, "tbody-2", "base");
          createButtons(data.advDeductData, "tbody-3", "adv");
          updateFeedbackArea();
          
          // åˆå§‹åŒ– Bootstrap tooltips
          const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
          const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
              boundary: document.body
            });
          });
          
          Swal.close();
        })
        .catch((error) => {
          alert("ç™¼ç”ŸéŒ¯èª¤ " + error);
        });

      function createButtons(items, containerId, type) {
        console.log(items);
        
        if (type === "praise") {
          const container = document.getElementById("condition-group-1");
          
          const groupedItems = {};
          const itemOrder = [];
          
          items.forEach(([title, description, content, result]) => {
            if (!groupedItems[title]) {
              groupedItems[title] = { description: description };
              itemOrder.push(title);
            }
            groupedItems[title][result] = content;
          });
          
          originalOrder = itemOrder;
          
          itemOrder.forEach(title => {
            const div = document.createElement("div");
            div.className = "condition-item";
            div.dataset.title = title;
            
            div.innerHTML = `
              <div class="condition-buttons">
                <button class="condition-btn correct-btn" data-type="O">
                  <i class="ph ph-circle"></i>
                </button>
                <button class="condition-btn incorrect-btn" data-type="X">
                  <i class="ph ph-x"></i>
                </button>
              </div>
              <div class="condition-text">${title}</div>
              <button class="info-button" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-trigger="hover" data-bs-title="${groupedItems[title].description}" onmouseenter="this.querySelector('i').className='ph-fill ph-info'" onmouseleave="this.querySelector('i').className='ph ph-info'">
                <i class="ph ph-info"></i>
              </button>
            `;
            
            const correctBtn = div.querySelector('.correct-btn');
            const incorrectBtn = div.querySelector('.incorrect-btn');
            
            correctBtn.onclick = (e) => {
              e.stopPropagation();
              handleConditionClick(title, 'O', groupedItems[title]['O'], correctBtn, incorrectBtn, type);
            };
            
            incorrectBtn.onclick = (e) => {
              e.stopPropagation();
              handleConditionClick(title, 'X', groupedItems[title]['X'], incorrectBtn, correctBtn, type);
            };
            
            container.appendChild(div);
          });
          
        } else if (type === "base" || type === "adv") {
          const targetDiv = type === "base" ? "advanced-conditions" : "challenge-conditions";
          
          const categorizedItems = {};
          const categoryOrder = {};
          
          items.forEach(([category, categoryDesc, item, content, score]) => {
            if (!categorizedItems[category]) {
              categorizedItems[category] = {
                description: categoryDesc,
                items: []
              };
              categoryOrder[category] = [];
            }
            categorizedItems[category].items.push([item, content, score]);
            categoryOrder[category].push(item);
          });
          
          // å„²å­˜æ¯å€‹é¡åˆ¥çš„é …ç›®æ•¸é‡
          Object.keys(categorizedItems).forEach(category => {
            const itemCount = categorizedItems[category].items.length;
            if (type === "base") {
              categoryItemCounts.advanced[category] = itemCount;
            } else {
              categoryItemCounts.challenge[category] = itemCount;
            }
          });
          
          if (type === "base") {
            originalOrderAdvanced = categoryOrder;
          } else {
            originalOrderChallenge = categoryOrder;
          }
          
          Object.keys(categorizedItems).forEach(category => {
            const categoryData = categorizedItems[category];
            
            const categoryDiv = document.createElement("div");
            categoryDiv.className = "category-section";
            categoryDiv.innerHTML = `
              <div class="category-row" style="margin-top: 12px;">
                <span>${category}</span>
                <button class="info-button" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-trigger="hover" data-bs-title="${categoryData.description}" onmouseenter="this.querySelector('i').className='ph-fill ph-info'" onmouseleave="this.querySelector('i').className='ph ph-info'">
                  <i class="ph ph-info"></i>
                </button>
              </div>
              <div class="category-items" id="${targetDiv}-${category.replace(/\s+/g, '-')}"></div>
            `;
            
            const targetElement = document.querySelector(`#${targetDiv}`);
            if (targetElement) {
              targetElement.appendChild(categoryDiv);
            }
            
            const itemsContainer = categoryDiv.querySelector('.category-items');
            categoryData.items.forEach(([item, content, score]) => {
              const itemDiv = document.createElement("div");
              itemDiv.className = "condition-item";
              itemDiv.dataset.category = category;
              itemDiv.dataset.item = item;
              itemDiv.innerHTML = `
                <i class="ph ph-circle" style="font-size: 24px; color: #6E7781; margin-right: 8px;"></i>
                <span style="margin-right: 8px;">${score > 0 ? '+' + score : score}</span>
                <span style="flex: 1;">${item}</span>
              `;
              
              itemDiv.onclick = () => {
                handleCategoryItemClick(category, item, content, score, type, itemDiv);
              };
              
              itemsContainer.appendChild(itemDiv);
            });
          });
        }
      }
      
      function handleCategoryItemClick(category, item, content, score, type, clickedDiv) {
        const icon = clickedDiv.querySelector("i");
        const isSelected = icon.classList.contains("ph-check-circle");
        
        if (isSelected) {
          icon.classList.remove("ph-fill", "ph-check-circle");
          icon.classList.add("ph", "ph-circle");
          deleteItem(item, content, score, type);
        } else {
          const categoryItems = document.querySelectorAll(`[data-category="${category}"]`);
          categoryItems.forEach(div => {
            const otherIcon = div.querySelector("i");
            if (otherIcon.classList.contains("ph-check-circle")) {
              otherIcon.classList.remove("ph-fill", "ph-check-circle");
              otherIcon.classList.add("ph", "ph-circle");
              const otherItem = div.dataset.item;
              feedbackList = feedbackList.filter(f => !(f.type === type && f.title === otherItem));
            }
          });
          
          icon.classList.remove("ph", "ph-circle");
          icon.classList.add("ph-fill", "ph-check-circle");
          addItem(item, content, score, type);
        }
        
        updateFeedbackArea();
      }
      
      function handleConditionClick(title, result, content, activeBtn, otherBtn, type) {
        otherBtn.classList.remove('active-correct', 'active-incorrect');
        
        const isCurrentlyActive = activeBtn.classList.contains('active-correct') || 
                                 activeBtn.classList.contains('active-incorrect');
        
        if (isCurrentlyActive) {
          activeBtn.classList.remove('active-correct', 'active-incorrect');
          deleteItem(title, content, 0, type);
        } else {
          if (result === 'O') {
            activeBtn.classList.add('active-correct');
          } else {
            activeBtn.classList.add('active-incorrect');
          }
          
          feedbackList = feedbackList.filter(item => item.title !== title);
          addItem(title, content, 0, type);
        }
      }

      function addItem(title, content, score, type) {
        const item = {
          content: `- ${content}`,
          title,
          score: parseInt(score),
          type,
        };
        feedbackList.push(item);
        updateFeedbackArea();
      }

      function deleteItem(title, content, score, type) {
        feedbackList = feedbackList.filter(
          (i) => !(i.title === title && i.type === type)
        );
        updateFeedbackArea();
      }

      function updateGradingResult() {
        const basicConditionItems = document.querySelectorAll('#condition-group-1 .condition-item');
        let basicAllChecked = true;
        let hasIncorrect = false;
        
        // æª¢æŸ¥åŸºæœ¬æ¢ä»¶
        basicConditionItems.forEach(item => {
          const correctBtn = item.querySelector('.correct-btn');
          const incorrectBtn = item.querySelector('.incorrect-btn');
          const isCorrect = correctBtn.classList.contains('active-correct');
          const isIncorrect = incorrectBtn.classList.contains('active-incorrect');
          
          if (!isCorrect && !isIncorrect) {
            basicAllChecked = false;
          }
          if (isIncorrect) {
            hasIncorrect = true;
          }
        });
        
        const resultDiv = document.getElementById('grading-result');
        
        // 1. å¦‚æœåŸºæœ¬æ¢ä»¶å°šæœªå®Œæˆ -> å°šæœªæ‰¹æ”¹å®Œæˆ
        if (!basicAllChecked) {
          resultDiv.innerHTML = 'é€™ä»½ä½œæ¥­å°šæœªæ‰¹æ”¹å®Œæˆ';
          resultDiv.style.color = '#6E7781';
          return;
        }
        
        // 2. å¾…åŠ å¼·ï¼šåŸºç¤æ¢ä»¶æœ‰ä»»ä½•ä¸€å€‹æ˜¯ X
        if (hasIncorrect) {
          resultDiv.innerHTML = 'åŒå­¸å°æ–¼æœ¬é€±çš„åŸºæœ¬çŸ¥è­˜ä»ä¸ç†Ÿæ‚‰ï¼Œå› æ­¤ä½œæ¥­è¡¨ç¾ç‚ºã€Œ<span style="color: #C84700; font-weight: bold;">å¾…åŠ å¼·</span>ã€ï¼Œç­é•·éœ€è¦å¤šèŠ±é»å¿ƒæ€ç•™æ„å­¸ç¿’ç‹€æ³ ğŸ¥º';
          resultDiv.style.color = '#32302C';
          return;
        }
        
        // 3. åŸºæœ¬æ¢ä»¶å…¨éƒ¨æ˜¯ Oï¼Œè¨ˆç®—é€²éšå’ŒæŒ‘æˆ°åˆ†æ•¸
        const advancedScore = calculateAverageScore('base');
        const challengeScore = calculateAverageScore('adv');
        
        console.log('é€²éšåˆ†æ•¸:', advancedScore, 'æŒ‘æˆ°åˆ†æ•¸:', challengeScore);
        
        resultDiv.style.color = '#32302C';
        
        // 4. æ¨¡ç¯„å€™é¸ï¼šåŸºç¤å…¨ O + é€²éšâ‰¥2åˆ† + æŒ‘æˆ°â‰¥2åˆ†
        if (advancedScore >= 2 && challengeScore >= 2) {
          resultDiv.innerHTML = 'åŒå­¸çš„ä½œæ¥­åœ¨é€²éšå’ŒæŒ‘æˆ°é …ç›®çš„è¡¨ç¾ååˆ†çªå‡ºï¼Œå¯åˆ—ç‚ºã€Œ<span style="color: #D5147E; font-weight: bold;">æ¨¡ç¯„å€™é¸</span>ã€ï¼Œå€¼å¾—åœ¨æ¦®è­½æ¦œå¤§åŠ›è¡¨æšï¼ğŸ¥³';
        }
        // 5. å„ªç§€å€™é¸ï¼šåŸºç¤å…¨ O + é€²éšâ‰¥2åˆ† + æŒ‘æˆ°<2åˆ†
        else if (advancedScore >= 2 && challengeScore < 2) {
          resultDiv.innerHTML = 'åŒå­¸åœ¨é€²éšé …ç›®è¡¨ç¾äº®çœ¼ï¼Œå› æ­¤ä½œæ¥­è¡¨ç¾å¯åˆ—å…¥ã€Œ<span style="color: #377ECC; font-weight: bold;">å„ªç§€å€™é¸</span>ã€ï¼æ˜¯åŒå­¸å€‘çš„å­¸ç¿’å°è±¡ ğŸ’ªğŸ»';
        }
        // 6. åŠæ ¼ï¼šåŸºç¤å…¨ O + é€²éš<2åˆ† + æŒ‘æˆ°<2åˆ†
        else {
          resultDiv.innerHTML = 'åŒå­¸æœ‰æŒæ¡æœ¬é€±çš„åŸºæœ¬çŸ¥è­˜ï¼Œä¹Ÿæœ‰å˜—è©¦é€²éšæˆ–æŒ‘æˆ°é …ç›®ï¼Œå› æ­¤ä½œæ¥­è¡¨ç¾ç‚ºã€Œ<span style="color: #57AD57; font-weight: bold;">åŠæ ¼</span>ã€ï¼Œç­é•·å¯ä»¥é©ç•¶çµ¦äºˆé¼“å‹µ ğŸ˜†';
        }
      }
      
      // ä¿®æ­£ç®—æ³•ï¼šæ¯å€‹é¡åˆ¥åªèƒ½é¸ä¸€å€‹ï¼Œåˆ†æ¯æ‡‰è©²æ˜¯é¡åˆ¥æ•¸é‡ï¼Œä¸æ˜¯é …ç›®æ•¸é‡
      function calculateAverageScore(type) {
        // å–å¾—ç›¸é—œçš„é¡åˆ¥æ•¸æ“š
        const categoryData = type === 'base' ? categoryItemCounts.advanced : categoryItemCounts.challenge;
        const categoryNames = Object.keys(categoryData);
        
        if (categoryNames.length === 0) return 0;
        
        let totalScore = 0;
        
        // å°æ¯å€‹é¡åˆ¥æ‰¾å‡ºè¢«é¸æ“‡çš„é …ç›®åˆ†æ•¸
        categoryNames.forEach(category => {
          // æ‰¾å‡ºè©²é¡åˆ¥ä¸­è¢«é¸æ“‡çš„é …ç›®
          const selectedItems = feedbackList.filter(item => 
            item.type === type && 
            document.querySelector(`[data-category="${category}"][data-item="${item.title}"]`)
          );
          
          // æ¯å€‹é¡åˆ¥åªèƒ½é¸ä¸€å€‹é …ç›®ï¼Œæ‰€ä»¥å–ç¬¬ä¸€å€‹é¸æ“‡çš„é …ç›®åˆ†æ•¸
          // å¦‚æœæ²’æœ‰é¸æ“‡ï¼Œå‰‡è©²é¡åˆ¥å¾— 0 åˆ†
          const categoryScore = selectedItems.length > 0 ? selectedItems[0].score : 0;
          totalScore += categoryScore;
        });
        
        // å›å‚³ç¸½åˆ†æ•¸ Ã· é¡åˆ¥æ•¸é‡
        return totalScore / categoryNames.length;
      }
      
      function updateFeedbackArea() {
        console.log(feedbackList);
        
        const orderedBasicConditions = [];
        if (originalOrder.length > 0) {
          originalOrder.forEach(title => {
            const item = feedbackList.find(f => f.type === "praise" && f.title === title);
            if (item) {
              orderedBasicConditions.push(item.content);
            }
          });
        }
        
        const orderedAdvancedConditions = [];
        Object.keys(originalOrderAdvanced).forEach(category => {
          originalOrderAdvanced[category].forEach(itemTitle => {
            const item = feedbackList.find(f => f.type === "base" && f.title === itemTitle);
            if (item) {
              orderedAdvancedConditions.push(item.content);
            }
          });
        });
        
        const orderedChallengeConditions = [];
        Object.keys(originalOrderChallenge).forEach(category => {
          originalOrderChallenge[category].forEach(itemTitle => {
            const item = feedbackList.find(f => f.type === "adv" && f.title === itemTitle);
            if (item) {
              orderedChallengeConditions.push(item.content);
            }
          });
        });
        
        const basic = orderedBasicConditions.length > 0 ? orderedBasicConditions.join("\n\n") : "- ";
        const advanced = orderedAdvancedConditions.length > 0 ? orderedAdvancedConditions.join("\n\n") : "";
        const challenge = orderedChallengeConditions.length > 0 ? orderedChallengeConditions.join("\n\n") : "";
        
        // è™•ç†é–‹é ­æ–‡å­—çš„æ›è¡Œï¼Œè®“ Notion è®Šæˆä¸åŒ block
        let processedOpeningText = '';
        if (openingText) {
          // ç¢ºä¿æ¯å€‹ \n éƒ½è®Šæˆ \n\nï¼Œä½†ä¸é‡è¤‡è™•ç†å·²ç¶“æ˜¯ \n\n çš„éƒ¨åˆ†
          processedOpeningText = openingText.replace(/\n(?!\n)/g, '\n\n');
        }
        
        let feedbackContent = `${processedOpeningText}\n\n### åŸºæœ¬æ¢ä»¶\n${basic}`;
        
        if (advanced) {
          feedbackContent += `\n\n### é€²éšæ¢ä»¶\n${advanced}`;
        }
        
        if (challenge) {
          feedbackContent += `\n\n### æŒ‘æˆ°æ¢ä»¶\n${challenge}`;
        }
        
        feedbackContent += `\n\n${closingText}`;
        
        md = feedbackContent;
        document.getElementById("previewArea").innerHTML = marked.parse(md);
        
        // æ›´æ–°è©•ç´šçµæœ
        updateGradingResult();
      }

      function copyFeedback() {
        // æª¢æŸ¥åŸºæœ¬æ¢ä»¶æ˜¯å¦éƒ½æœ‰è¢«é¸æ“‡
        const basicConditionItems = document.querySelectorAll('#condition-group-1 .condition-item');
        let hasUnselectedItems = false;
        
        basicConditionItems.forEach(item => {
          const correctBtn = item.querySelector('.correct-btn');
          const incorrectBtn = item.querySelector('.incorrect-btn');
          const isSelected = correctBtn.classList.contains('active-correct') || 
                            incorrectBtn.classList.contains('active-incorrect');
          if (!isSelected) {
            hasUnselectedItems = true;
          }
        });
        
        if (hasUnselectedItems) {
          // é¡¯ç¤ºè­¦å‘Š Modal
          const modal = new bootstrap.Modal(document.getElementById('incompleteModal'));
          modal.show();
          return;
        }
        
        // å¦‚æœéƒ½æœ‰é¸æ“‡ï¼Œå‰‡é€²è¡Œè¤‡è£½
        navigator.clipboard
          .writeText(md)
          .then(() => {
            showCopyToast();
          })
          .catch((err) => {
            alert("è¤‡è£½å¤±æ•—");
          });
      }

      function showCopyToast() {
        const copyBtn = document.querySelector('.btn-copy');
        
        // ç§»é™¤å·²å­˜åœ¨çš„ toast
        const existingToast = copyBtn.querySelector('.copy-toast');
        if (existingToast) {
          existingToast.remove();
        }
        
        // å‰µå»ºæ–°çš„ toast
        const toast = document.createElement('div');
        toast.className = 'copy-toast';
        toast.textContent = 'å·²è¤‡è£½';
        copyBtn.appendChild(toast);
        
        // é¡¯ç¤ºå‹•ç•«
        setTimeout(() => {
          toast.classList.add('show');
        }, 10);
        
        // 1ç§’å¾Œéš±è—ä¸¦ç§»é™¤
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 1000);
      }

      function clearFeedback() {
        feedbackList = [];
        
        // æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.condition-btn').forEach(btn => {
          btn.classList.remove('active-correct', 'active-incorrect');
        });
        
        document.querySelectorAll('.category-items .condition-item i').forEach(icon => {
          icon.classList.remove("ph-fill", "ph-check-circle");
          icon.classList.add("ph", "ph-circle");
        });
        
        updateFeedbackArea();
      }
    </script>
  </body>
</html>
